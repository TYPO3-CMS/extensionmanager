/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","nprogress","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Tooltip","TYPO3/CMS/Backend/Severity","TYPO3/CMS/Core/SecurityUtility","./Repository","./Update","./UploadForm","datatables","TYPO3/CMS/Backend/jquery.clearable"],function(n,e,t,o,i,a,r,s,l,c,u){"use strict";var d,p=new s;!function(n){n.extensionlist="#typo3-extension-list",n.searchField="#Tx_Extensionmanager_extensionkey"}(d||(d={}));var f=new(function(){function n(){var e=this;this.bindExtensionListActions=function(){t(".removeExtension").not(".transformed").each(function(n,o){var a=t(o);a.data("href",a.attr("href")),a.attr("href","#"),a.addClass("transformed"),a.click(function(){i.confirm(TYPO3.lang["extensionList.removalConfirmation.title"],TYPO3.lang["extensionList.removalConfirmation.question"],r.error,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:function(){i.dismiss()}},{text:TYPO3.lang["button.remove"],btnClass:"btn-danger",trigger:function(){e.removeExtensionFromDisk(a),i.dismiss()}}])})})},t(function(){t.fn.dataTableExt.oSort["extension-asc"]=function(e,t){return n.extensionCompare(e,t)},t.fn.dataTableExt.oSort["extension-desc"]=function(e,t){return-1*n.extensionCompare(e,t)},t.fn.dataTableExt.oSort["version-asc"]=function(e,t){return-1*n.versionCompare(e,t)},t.fn.dataTableExt.oSort["version-desc"]=function(e,t){return n.versionCompare(e,t)},e.Update=new c,e.UploadForm=new u,e.Repository=new l;var i=e.manageExtensionListing();t(document).on("click",".onClickMaskExtensionManager",function(){o.start()}).on("click","a[data-action=update-extension]",function(n){n.preventDefault(),t.ajax({url:t(e).attr("href"),dataType:"json",beforeSend:function(){o.start()},success:e.updateExtension})}).on("change","input[name=unlockDependencyIgnoreButton]",function(n){t(".t3js-dependencies").toggleClass("disabled",!t(n.currentTarget).prop("checked"))}),t(d.searchField).clearable({onClear:function(){i.search("").draw()}}),t(document).on("click",".t3-button-action-installdistribution",function(){o.start()}),e.Repository.initDom(),e.Update.initializeEvents(),e.UploadForm.initializeEvents(),a.initialize("#typo3-extension-list [title]",{delay:{show:500,hide:100},trigger:"hover",container:"body"})})}return n.prototype.manageExtensionListing=function(){var e=t(d.searchField),o=t(d.extensionlist).DataTable({paging:!1,dom:"lrtip",lengthChange:!1,pageLength:15,stateSave:!0,drawCallback:this.bindExtensionListActions,columns:[null,null,{type:"extension"},null,{type:"version"},{orderable:!1},null,null]});e.parents("form").on("submit",function(){return!1});var i=n.getUrlVars(),a=i.search?i.search:o.search();return e.val(a),e.on("input",function(n){o.search(t(n.currentTarget).val()).draw()}),o},n.prototype.removeExtensionFromDisk=function(n){t.ajax({url:n.data("href"),beforeSend:function(){o.start()},success:function(){location.reload()},complete:function(){o.done()}})},n.getUrlVars=function(){for(var n,e=[],t=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),o=0;o<t.length;o++)n=t[o].split("="),e.push(n[0]),e[n[0]]=n[1];return e},n.versionCompare=function(n,e){if(n===e)return 0;for(var t=n.split("."),o=e.split("."),i=Math.min(t.length,o.length),a=0;a<i;a++){if(parseInt(t[a],10)>parseInt(o[a],10))return 1;if(parseInt(t[a],10)<parseInt(o[a],10))return-1}return t.length>o.length?1:t.length<o.length?-1:0},n.extensionCompare=function(n,e){var t=document.createElement("div");t.innerHTML=n;var o=t.textContent||t.innerText||n;t.innerHTML=e;var i=t.textContent||t.innerText||e;return o.trim().localeCompare(i.trim())},n.prototype.updateExtension=function(n){var e=0,a=t("<form>");t.each(n.updateComments,function(n,o){var i=t("<input>").attr({type:"radio",name:"version"}).val(n);0===e&&i.attr("checked","checked"),a.append([t("<h3>").append([i," "+p.encodeHtml(n)]),t("<div>").append(o.replace(/(\r\n|\n\r|\r|\n)/g,"\n").split(/\n/).map(function(n){return p.encodeHtml(n)}).join("<br>"))]),e++});var s=t("<div>").append([t("<h1>").text(TYPO3.lang["extensionList.updateConfirmation.title"]),t("<h2>").text(TYPO3.lang["extensionList.updateConfirmation.message"]),a]);o.done(),i.confirm(TYPO3.lang["extensionList.updateConfirmation.questionVersionComments"],s,r.warning,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:function(){i.dismiss()}},{text:TYPO3.lang["button.updateExtension"],btnClass:"btn-warning",trigger:function(){t.ajax({url:n.url,data:{tx_extensionmanager_tools_extensionmanagerextensionmanager:{version:t("input:radio[name=version]:checked",i.currentModal).val()}},dataType:"json",beforeSend:function(){o.start()},complete:function(){location.reload()}}),i.dismiss()}}])},n}());return void 0===TYPO3.ExtensionManager&&(TYPO3.ExtensionManager=f),f});