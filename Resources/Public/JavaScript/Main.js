/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define(["require","exports","jquery","TYPO3/CMS/Backend/Storage/BrowserSession","nprogress","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Tooltip","TYPO3/CMS/Backend/Severity","TYPO3/CMS/Core/SecurityUtility","./Repository","./Update","./UploadForm","TYPO3/CMS/Core/Ajax/AjaxRequest","TYPO3/CMS/Core/Event/DebounceEvent","TYPO3/CMS/Core/Event/RegularEvent","tablesort","tablesort.dotsep","TYPO3/CMS/Backend/Input/Clearable"],(function(e,t,n,i,a,o,s,r,l,d,u,c,f,m,p){"use strict";n=__importDefault(n),a=__importDefault(a);const g=new l;var h;!function(e){e.extensionlist="typo3-extension-list",e.searchField="#Tx_Extensionmanager_extensionkey"}(h||(h={}));let x=new class{constructor(){this.searchFilterSessionKey="tx-extensionmanager-local-filter";const e=this;(0,n.default)(()=>{this.Update=new u,this.UploadForm=new c,this.Repository=new d;const t=document.getElementById(h.extensionlist);let l;if(null!==t&&(new Tablesort(t),new p("click",(function(t){t.preventDefault(),o.confirm(TYPO3.lang["extensionList.removalConfirmation.title"],TYPO3.lang["extensionList.removalConfirmation.question"],r.error,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{o.dismiss()}},{text:TYPO3.lang["button.remove"],btnClass:"btn-danger",trigger:()=>{e.removeExtensionFromDisk(this),o.dismiss()}}])})).delegateTo(t,".removeExtension")),(0,n.default)(document).on("click",".onClickMaskExtensionManager",()=>{a.default.start()}).on("click","a[data-action=update-extension]",e=>{e.preventDefault(),a.default.start(),new f((0,n.default)(e.currentTarget).attr("href")).get().then(this.updateExtension)}).on("change","input[name=unlockDependencyIgnoreButton]",e=>{(0,n.default)(".t3js-dependencies").toggleClass("disabled",!(0,n.default)(e.currentTarget).prop("checked"))}),null!==(l=document.querySelector(h.searchField))){const e=i.get(this.searchFilterSessionKey);null!==e&&(l.value=e,this.filterExtensions(e)),new p("submit",e=>{e.preventDefault()}).bindTo(l.closest("form")),new m("input",e=>{const t=e.target;i.set(this.searchFilterSessionKey,t.value),this.filterExtensions(t.value)},100).bindTo(l),l.clearable({onClear:()=>{i.unset(this.searchFilterSessionKey),this.filterExtensions("")}})}(0,n.default)(document).on("click",".t3-button-action-installdistribution",()=>{a.default.start()}),this.Repository.initDom(),this.Update.initializeEvents(),this.UploadForm.initializeEvents(),s.initialize("#typo3-extension-list [title]")})}filterExtensions(e){const t=document.querySelectorAll("[data-filterable]"),n=[];t.forEach(e=>{const t=Array.from(e.parentElement.children);n.push(t.indexOf(e))});document.querySelectorAll("#typo3-extension-list tbody tr").forEach(t=>{const i=n.map(e=>t.children.item(e)),a=[];i.forEach(e=>{a.push(e.textContent.trim().replace(/\s+/g," "))}),t.classList.toggle("hidden",""!==e&&!RegExp(e,"i").test(a.join(":")))})}removeExtensionFromDisk(e){a.default.start(),new f(e.href).get().then(()=>{location.reload()}).finally(()=>{a.default.done()})}async updateExtension(e){let t=0;const i=await e.resolve(),s=(0,n.default)("<form>");n.default.each(i.updateComments,(e,i)=>{const a=(0,n.default)("<input>").attr({type:"radio",name:"version"}).val(e);0===t&&a.attr("checked","checked"),s.append([(0,n.default)("<h3>").append([a," "+g.encodeHtml(e)]),(0,n.default)("<div>").append(i.replace(/(\r\n|\n\r|\r|\n)/g,"\n").split(/\n/).map(e=>g.encodeHtml(e)).join("<br>"))]),t++});const l=(0,n.default)("<div>").append([(0,n.default)("<h1>").text(TYPO3.lang["extensionList.updateConfirmation.title"]),(0,n.default)("<h2>").text(TYPO3.lang["extensionList.updateConfirmation.message"]),s]);a.default.done(),o.confirm(TYPO3.lang["extensionList.updateConfirmation.questionVersionComments"],l,r.warning,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{o.dismiss()}},{text:TYPO3.lang["button.updateExtension"],btnClass:"btn-warning",trigger:()=>{a.default.start(),new f(i.url).withQueryArguments({tx_extensionmanager_tools_extensionmanagerextensionmanager:{version:(0,n.default)("input:radio[name=version]:checked",o.currentModal).val()}}).get().finally(()=>{location.reload()}),o.dismiss()}}])}};return void 0===TYPO3.ExtensionManager&&(TYPO3.ExtensionManager=x),x}));